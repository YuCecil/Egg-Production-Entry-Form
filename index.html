<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>養雞場紀錄</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: sans-serif;
            touch-action: manipulation;
        }

        .btn-active:active {
            transform: scale(0.95);
        }

        button {
            touch-action: manipulation;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ⚠️ 設定區：請將您的 GAS 網址貼在下方
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycby6dZKeLISAcjX2Tp7MiN3WZupNWNI8UnwyD6rSW1vp3mOoUA4tZIlMd4LRkJlebDS72w/exec";

        const { useState, useEffect, useRef } = React;

        // --- Icons (完全保留您原本的圖示) ---
        const IconWarehouse = () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35A2 2 0 0 1 3.26 6.5l8-3.2a2 2 0 0 1 1.48 0l8 3.2A2 2 0 0 1 22 8.35Z" /><path d="M6 18h12" /><path d="M6 14h12" /></svg>;
        const IconTrees = () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1-5.8V10a3 3 0 0 1 5.3-2.1" /><path d="M7 16v6" /><path d="M13 19v3" /><path d="M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .9-1.7l-3.5-5a1.08 1.08 0 0 0-1.8 0l-3.5 5a1 1 0 0 0 .9 1.7l.2.1a3 3 0 0 1-2 5.2" /></svg>;
        const IconEgg = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c6.23-.05 7.87-5.57 7.5-10-.36-4.34-3.95-9.96-7.5-10-3.55.04-7.14 5.66-7.5 10-.37 4.43 1.27 9.95 7.5 10z" /></svg>;
        const IconSkull = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1" /><circle cx="15" cy="12" r="1" /><path d="M8 20v2h8v-2" /><path d="m12.5 17-.5-1-.5 1h1z" /><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20" /></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5" /></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></svg>;
        const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5" /><path d="m12 19-7-7 7-7" /></svg>;
        const IconChevronLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6" /></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></svg>;
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="M12 5v14" /></svg>;
        const IconMinus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>;
        const IconWater = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" /></svg>;
        const IconBroken = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 2v4" /><path d="M12 18v4" /><path d="M4.93 4.93l2.83 2.83" /><path d="M16.24 16.24l2.83 2.83" /><path d="M2 12h4" /><path d="M18 12h4" /><path d="M4.93 19.07l2.83-2.83" /><path d="M16.24 7.76l2.83-2.83" /></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></svg>;

        // --- 主程式 ---
        const App = () => {
            const [step, setStep] = useState('DATE');
            const [date, setDate] = useState(new Date());
            const [dateType, setDateType] = useState('TODAY');
            const [currentZone, setCurrentZone] = useState(null);
            const [currentRowIndex, setCurrentRowIndex] = useState(1);
            const [batchData, setBatchData] = useState({});

            const [eggInput, setEggInput] = useState('0'); // 預設改為 0
            const [deadInput, setDeadInput] = useState('0');

            // 獨立的每日數據
            const [waterInput, setWaterInput] = useState('0');
            const [brokenInput, setBrokenInput] = useState('0');
            // 用來判斷 Numpad 是給誰用
            const [numpadTarget, setNumpadTarget] = useState(null); // 'WATER' or 'BROKEN'

            const [activeField, setActiveField] = useState('EGG');
            const [isSaving, setIsSaving] = useState(false);

            const zones = {
                FRONT: { id: 'FRONT', name: 'Depan', subName: '倉庫前', color: 'bg-blue-600', border: 'border-blue-800', icon: <IconWarehouse />, count: 4 },
                BACK: { id: 'BACK', name: 'Belakang', subName: '後面', color: 'bg-green-600', border: 'border-green-800', icon: <IconTrees />, count: 8 }
            };

            const getIndoDay = (d) => {
                const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                return days[d.getDay()];
            };

            const formatDateWithDay = (d) => {
                const dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                return `${getIndoDay(d)}, ${dateStr}`;
            };

            // 專門產生給後端 (老闆) 看的日期格式 YYYY/MM/DD
            const formatDateForBackend = (d) => {
                return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
            };

            // --- 數字鍵盤邏輯 ---
            const handleNumPad = (num) => {
                // 如果是全域數據輸入 (水蛋/破蛋)
                if (step === 'GLOBAL_INPUT') {
                    const currentVal = numpadTarget === 'WATER' ? waterInput : brokenInput;
                    const setVal = numpadTarget === 'WATER' ? setWaterInput : setBrokenInput;
                    if (currentVal.length >= 3) return;
                    if (currentVal === '0') setVal(num);
                    else setVal(currentVal + num);
                    return;
                }

                // 區域排數輸入
                if (activeField === 'EGG') {
                    if (eggInput.length >= 3) return;
                    if (eggInput === '0') setEggInput(num);
                    else setEggInput(eggInput + num);
                } else {
                    if (deadInput.length >= 2) return;
                    if (deadInput === '0') setDeadInput(num);
                    else setDeadInput(deadInput + num);
                }
            };

            const handleBackspace = () => {
                if (step === 'GLOBAL_INPUT') {
                    const currentVal = numpadTarget === 'WATER' ? waterInput : brokenInput;
                    const setVal = numpadTarget === 'WATER' ? setWaterInput : setBrokenInput;
                    if (currentVal.length <= 1) setVal('0');
                    else setVal(currentVal.slice(0, -1));
                    return;
                }

                if (activeField === 'EGG') {
                    if (eggInput.length <= 1) setEggInput('0');
                    else setEggInput(eggInput.slice(0, -1));
                } else {
                    if (deadInput.length <= 1) setDeadInput('0');
                    else setDeadInput(deadInput.slice(0, -1));
                }
            };

            const adjustNumber = (field, delta) => {
                if (field === 'EGG') {
                    let val = parseInt(eggInput) || 0;
                    val += delta;
                    if (val < 0) val = 0;
                    setEggInput(val.toString());
                    setActiveField('EGG');
                } else if (field === 'DEAD') {
                    let val = parseInt(deadInput) || 0;
                    val += delta;
                    if (val < 0) val = 0;
                    setDeadInput(val.toString());
                    setActiveField('DEAD');
                } else if (field === 'WATER') {
                    let val = parseInt(waterInput) || 0;
                    val += delta;
                    if (val < 0) val = 0;
                    setWaterInput(val.toString());
                    setNumpadTarget('WATER'); // 讓鍵盤對應它
                } else if (field === 'BROKEN') {
                    let val = parseInt(brokenInput) || 0;
                    val += delta;
                    if (val < 0) val = 0;
                    setBrokenInput(val.toString());
                    setNumpadTarget('BROKEN'); // 讓鍵盤對應它
                }
            };

            // --- 進入流程 ---
            const startBatchInput = (zoneKey) => {
                setCurrentZone(zones[zoneKey]);
                setBatchData({});
                setCurrentRowIndex(1);
                setEggInput('0'); // 重置時改為 0
                setDeadInput('0');
                setActiveField('EGG');
                setStep('WIZARD');
            };

            const startGlobalInput = () => {
                setWaterInput('0');
                setBrokenInput('0');
                setNumpadTarget('WATER'); // 預設先輸入水蛋
                setStep('GLOBAL_INPUT');
            };

            // --- 導航與儲存 ---
            const handleExitWizard = () => {
                if (confirm("Keluar? Data akan hilang.\n確定要退出嗎？")) {
                    setStep('ZONE');
                }
            };

            const handlePrevRow = () => {
                const currentData = { egg: eggInput || '0', dead: deadInput || '0' };
                const newData = { ...batchData, [currentRowIndex]: currentData };
                setBatchData(newData);
                if (currentRowIndex > 1) {
                    const prevIndex = currentRowIndex - 1;
                    const prevData = newData[prevIndex] || { egg: '0', dead: '0' }; // 預設改為 0
                    setEggInput(prevData.egg);
                    setDeadInput(prevData.dead);
                    setActiveField('EGG');
                    setCurrentRowIndex(prevIndex);
                }
            };

            const handleNextRow = () => {
                const newData = { ...batchData, [currentRowIndex]: { egg: eggInput || '0', dead: deadInput || '0' } };
                setBatchData(newData);
                if (currentRowIndex < currentZone.count) {
                    const nextIndex = currentRowIndex + 1;
                    const existingNextData = batchData[nextIndex];
                    setEggInput(existingNextData ? existingNextData.egg : '0'); // 預設改為 0
                    setDeadInput(existingNextData ? existingNextData.dead : '0');
                    setActiveField('EGG');
                    setCurrentRowIndex(nextIndex);
                } else {
                    setStep('SUMMARY');
                }
            };

            const handleEditRow = (rowIndex) => {
                const data = batchData[rowIndex];
                setCurrentRowIndex(parseInt(rowIndex));
                setEggInput(data.egg);
                setDeadInput(data.dead);
                setStep('WIZARD');
            };

            const handleCancel = () => {
                if (confirm("Batal? Data akan hilang.\n確定要取消嗎？")) {
                    setStep('DATE');
                }
            };

            // -------------------------------------------------------------
            // 修改重點：使用 fetch 替代原本的 google.script.run
            // -------------------------------------------------------------
            const handleFinalSubmit = async (type) => {
                setIsSaving(true);
                let payload = {};

                // 重點：傳送給後端的資料全部使用中文
                const dateForSheet = formatDateForBackend(date);

                if (type === 'ZONE_DATA') {
                    payload = {
                        type: 'ZONE_DATA',
                        date: dateForSheet,
                        zone: currentZone.subName, // 使用中文名稱 (倉庫前/後面)
                        data: batchData
                    };
                } else {
                    // GLOBAL DATA
                    payload = {
                        type: 'DAILY_DATA',
                        date: dateForSheet,
                        waterEgg: waterInput,
                        brokenEgg: brokenInput
                    };
                }

                // --- 新的 Fetch 邏輯 ---
                if (API_URL.includes("您的測試用GAS")) {
                    alert("請先編輯 index.html 設定 API_URL！");
                    setIsSaving(false);
                    return;
                }

                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });

                    const res = await response.json();

                    setIsSaving(false);
                    if (res.success) {
                        setStep('SUCCESS');
                    } else {
                        alert("Gagal (失敗): " + res.message);
                    }

                } catch (e) {
                    setIsSaving(false);
                    console.error(e);
                    alert("Error (連線錯誤): " + e.message);
                }
            };

            // --- 共用組件 ---
            const Numpad = ({ onNum, onBack, extraClass }) => (
                <div className={`grid grid-cols-3 gap-2 h-full ${extraClass}`}>
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => <button key={n} onClick={() => onNum(n.toString())} className="bg-white rounded-xl text-4xl font-bold text-gray-700 active:bg-gray-100 shadow-sm border-b-4 border-gray-300 py-3">{n}</button>)}
                    <button onClick={() => onNum('0')} className="col-span-2 bg-white rounded-xl text-4xl font-bold text-gray-700 active:bg-gray-100 shadow-sm border-b-4 border-gray-300 py-3">0</button>
                    <button onClick={onBack} className="bg-gray-300 rounded-xl flex items-center justify-center active:bg-gray-400 border-b-4 border-gray-400 py-3"><IconChevronLeft /></button>
                </div>
            );

            // --- 畫面渲染 ---
            const DateScreen = () => {
                const getYYYYMMDD = (d) => {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                return (
                    <div className="flex flex-col h-full bg-gray-50 p-4 gap-3">
                        <h1 className="text-2xl font-bold text-center text-gray-700">Tanggal <span className="text-sm font-normal">(日期)</span></h1>
                        <button onClick={() => { setDate(new Date()); setDateType('TODAY'); setStep('ZONE'); }} className="flex-1 bg-orange-500 text-white rounded-2xl flex flex-col items-center justify-center shadow-lg active:scale-95 border-b-8 border-orange-700">
                            <IconSun />
                            <span className="text-4xl font-bold mt-2">Hari Ini</span>
                            <span className="text-lg opacity-80 font-bold mb-2">(今天)</span>
                            <span className="text-xl font-mono bg-black/20 px-4 py-1 rounded-full">{formatDateWithDay(new Date())}</span>
                        </button>
                        <div className="relative h-24 w-full">
                            <input
                                type="date"
                                className="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer"
                                value={getYYYYMMDD(date)}
                                onChange={(e) => {
                                    if (e.target.value) {
                                        const [y, m, d] = e.target.value.split('-');
                                        setDate(new Date(y, m - 1, d));
                                        setDateType('PICK');
                                        setStep('ZONE');
                                    }
                                }}
                            />
                            <div className="w-full h-full bg-blue-500 text-white rounded-2xl flex items-center justify-center gap-4 shadow-lg border-b-8 border-blue-700 active:scale-95 transition-transform">
                                <IconCalendar />
                                <div className="text-left">
                                    <div className="text-2xl font-bold">Pilih Tanggal</div>
                                    <div className="text-lg opacity-80 font-bold">(選其他日期)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const ZoneScreen = () => (
                <div className="flex flex-col h-full bg-white p-4 gap-4">
                    <div className="flex justify-between items-center bg-gray-100 p-3 rounded-xl">
                        <span className="text-lg font-bold text-gray-800">{formatDateWithDay(date)}</span>
                        <button onClick={() => setStep('DATE')} className="text-blue-600 font-bold underline text-sm">Ganti (重選)</button>
                    </div>
                    <div className="flex-1 flex flex-col gap-4">
                        <button onClick={() => startBatchInput('FRONT')} className={`${zones.FRONT.color} flex-1 rounded-3xl text-white shadow-xl border-b-8 ${zones.FRONT.border} active:scale-95 p-4 flex flex-col items-center justify-center`}>
                            <div className="flex items-center gap-3">
                                <IconWarehouse />
                                <span className="text-4xl font-black">{zones.FRONT.name}</span>
                            </div>
                            <div className="text-xl opacity-80 font-bold mt-1">({zones.FRONT.subName})</div>
                        </button>

                        <button onClick={() => startBatchInput('BACK')} className={`${zones.BACK.color} flex-1 rounded-3xl text-white shadow-xl border-b-8 ${zones.BACK.border} active:scale-95 p-4 flex flex-col items-center justify-center`}>
                            <div className="flex items-center gap-3">
                                <IconTrees />
                                <span className="text-4xl font-black">{zones.BACK.name}</span>
                            </div>
                            <div className="text-xl opacity-80 font-bold mt-1">({zones.BACK.subName})</div>
                        </button>

                        {/* 全域數據輸入按鈕 (紫色) */}
                        <button onClick={startGlobalInput} className="bg-purple-600 flex-1 rounded-3xl text-white shadow-xl border-b-8 border-purple-800 active:scale-95 p-4 flex flex-col items-center justify-center">
                            <div className="flex items-center gap-3">
                                <IconList />
                                <span className="text-2xl font-black">Telur dicuci & pecah</span>
                            </div>
                            <div className="text-lg opacity-80 font-bold mt-1">(水蛋與破蛋)</div>
                        </button>
                    </div>
                </div>
            );

            // --- 水蛋/破蛋 輸入頁面 ---
            const GlobalInputScreen = () => {
                return (
                    <div className="flex flex-col h-full bg-gray-50">
                        <div className="bg-purple-600 text-white p-4 shadow-md relative">
                            <button onClick={() => setStep('ZONE')} className="absolute left-3 top-4 p-2 bg-white/20 rounded-lg"><IconX /></button>
                            <div className="text-center">
                                <h2 className="text-xl font-bold">Telur dicuci & pecah</h2>
                                <div className="text-sm opacity-80 font-bold">(水蛋與破蛋)</div>
                            </div>
                            <div className="absolute right-3 top-5 text-xs font-bold opacity-80">{formatDateWithDay(date)}</div>
                        </div>

                        <div className="flex gap-2 p-3 bg-white shadow-sm z-10">
                            {/* 水蛋輸入框 */}
                            <div onClick={() => setNumpadTarget('WATER')} className={`flex-1 p-2 rounded-xl border-4 flex flex-col items-center transition-colors ${numpadTarget === 'WATER' ? 'border-blue-400 bg-blue-50' : 'border-gray-100'}`}>
                                <div className="flex items-center gap-1 text-blue-600 font-bold text-sm mb-1"><IconWater /> Telur dicuci (水蛋)</div>
                                <div className="flex items-center w-full justify-between px-1">
                                    <button onClick={(e) => { e.stopPropagation(); adjustNumber('WATER', -1) }} className="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center active:bg-gray-300 font-bold text-xl">-</button>
                                    <span className="text-4xl font-mono font-bold text-gray-800">{waterInput}</span>
                                    <button onClick={(e) => { e.stopPropagation(); adjustNumber('WATER', 1) }} className="w-10 h-10 bg-blue-200 text-blue-800 rounded-lg flex items-center justify-center active:bg-blue-300 font-bold text-xl">+</button>
                                </div>
                            </div>
                            {/* 破蛋輸入框 */}
                            <div onClick={() => setNumpadTarget('BROKEN')} className={`flex-1 p-2 rounded-xl border-4 flex flex-col items-center transition-colors ${numpadTarget === 'BROKEN' ? 'border-red-400 bg-red-50' : 'border-gray-100'}`}>
                                <div className="flex items-center gap-1 text-red-600 font-bold text-sm mb-1"><IconBroken /> Telur pecah (破蛋)</div>
                                <div className="flex items-center w-full justify-between px-1">
                                    <button onClick={(e) => { e.stopPropagation(); adjustNumber('BROKEN', -1) }} className="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center active:bg-gray-300 font-bold text-xl">-</button>
                                    <span className="text-4xl font-mono font-bold text-gray-800">{brokenInput}</span>
                                    <button onClick={(e) => { e.stopPropagation(); adjustNumber('BROKEN', 1) }} className="w-10 h-10 bg-red-200 text-red-800 rounded-lg flex items-center justify-center active:bg-red-300 font-bold text-xl">+</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 bg-gray-200 p-2">
                            <Numpad onNum={handleNumPad} onBack={handleBackspace} />
                        </div>

                        <div className="p-4 bg-white border-t border-gray-200 shadow-lg">
                            <button onClick={() => handleFinalSubmit('DAILY_DATA')} disabled={isSaving} className="w-full bg-green-600 text-white rounded-xl py-3 shadow-lg flex flex-col items-center justify-center active:scale-95 border-b-4 border-green-800 disabled:opacity-50">
                                {isSaving ? (
                                    <span className="text-xl font-bold">Menyimpan...</span>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-2"><IconSave /><span className="text-2xl font-bold">Simpan</span></div>
                                        <span className="text-xs opacity-80 font-bold">(存檔)</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                );
            };

            const WizardScreen = () => (
                <div className="flex flex-col h-full bg-gray-50">
                    <div className={`${currentZone.color} text-white p-3 shadow-md flex justify-between items-center relative`}>
                        <button onClick={handleExitWizard} className="bg-red-500/80 p-2 rounded-lg active:bg-red-600 border-2 border-red-700 absolute left-3"><IconX /></button>
                        <div className="flex flex-col items-center w-full">
                            <div className="flex items-center gap-2"><span className="text-2xl font-bold">{currentZone.name}</span></div>
                            <span className="text-sm font-bold opacity-80">{currentZone.subName}</span>
                        </div>
                        <div className="bg-black/20 px-3 py-1 rounded-lg absolute right-3 text-center">
                            <span className="text-xs opacity-80 block">Baris (排)</span>
                            <span className="text-2xl font-black">{currentRowIndex}</span>
                        </div>
                    </div>

                    <div className="flex gap-2 p-3 bg-white shadow-sm relative z-10">
                        <div className={`flex-1 p-1 rounded-xl border-4 flex flex-col items-center transition-colors ${activeField === 'EGG' ? 'border-yellow-400 bg-yellow-50' : 'border-gray-100'}`}>
                            <div onClick={() => setActiveField('EGG')} className="flex items-center gap-1 text-gray-500 font-bold text-sm mb-1"><IconEgg /> Telur (蛋)</div>
                            <div className="flex items-center w-full justify-between px-1">
                                <button onClick={(e) => { e.stopPropagation(); adjustNumber('EGG', -1) }} className="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center active:bg-gray-300"><IconMinus size={20} /></button>
                                <span onClick={() => setActiveField('EGG')} className="text-4xl font-mono font-bold text-gray-800">{eggInput || '-'}</span>
                                <button onClick={(e) => { e.stopPropagation(); adjustNumber('EGG', 1) }} className="w-10 h-10 bg-yellow-400 text-white rounded-lg flex items-center justify-center active:bg-yellow-500 shadow-sm"><IconPlus size={20} /></button>
                            </div>
                        </div>
                        <div className={`flex-1 p-1 rounded-xl border-4 flex flex-col items-center transition-colors ${activeField === 'DEAD' ? 'border-red-400 bg-red-50' : 'border-gray-100'}`}>
                            <div onClick={() => setActiveField('DEAD')} className="flex items-center gap-1 text-gray-500 font-bold text-sm mb-1"><IconSkull /> Mati (死)</div>
                            <div className="flex items-center w-full justify-between px-1">
                                <button onClick={(e) => { e.stopPropagation(); adjustNumber('DEAD', -1) }} className="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center active:bg-gray-300"><IconMinus size={20} /></button>
                                <span onClick={() => setActiveField('DEAD')} className="text-4xl font-mono font-bold text-gray-800">{deadInput || '-'}</span>
                                <button onClick={(e) => { e.stopPropagation(); adjustNumber('DEAD', 1) }} className="w-10 h-10 bg-red-400 text-white rounded-lg flex items-center justify-center active:bg-red-500 shadow-sm"><IconPlus size={20} /></button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 bg-gray-200 p-2">
                        <Numpad onNum={handleNumPad} onBack={handleBackspace} />
                    </div>

                    <div className="p-3 bg-white border-t border-gray-200 shadow-lg z-20">
                        <div className="flex gap-3">
                            {currentRowIndex > 1 ? (
                                <>
                                    <button onClick={handlePrevRow} className="flex-1 bg-yellow-500 text-white rounded-xl py-3 font-bold shadow-md border-b-4 border-yellow-700 active:scale-95 flex flex-col items-center justify-center max-w-[30%]">
                                        <IconArrowLeft size={24} />
                                        <span className="text-sm mt-1">Kembali</span>
                                        <span className="text-xs opacity-80">(上一排)</span>
                                    </button>
                                    <button onClick={handleNextRow} disabled={!eggInput && !deadInput} className={`flex-[2] rounded-xl flex items-center justify-center gap-2 py-3 shadow-md text-white border-b-4 ${(!eggInput && !deadInput) ? 'bg-gray-400 border-gray-500' : 'bg-blue-600 border-blue-800 active:scale-95'}`}>
                                        <div className="text-center">
                                            <div className="text-xl font-bold">{currentRowIndex < currentZone.count ? 'Lanjut' : 'Selesai'}</div>
                                            <div className="text-xs opacity-80 font-bold">{currentRowIndex < currentZone.count ? '(下一排)' : '(完成)'}</div>
                                        </div>
                                        <IconArrowRight />
                                    </button>
                                </>
                            ) : (
                                <button onClick={handleNextRow} disabled={!eggInput && !deadInput} className={`w-full rounded-xl flex items-center justify-center gap-2 py-3 shadow-md text-white border-b-4 ${(!eggInput && !deadInput) ? 'bg-gray-400 border-gray-500' : 'bg-blue-600 border-blue-800 active:scale-95'}`}>
                                    <div className="text-center">
                                        <div className="text-xl font-bold">{currentRowIndex < currentZone.count ? 'Lanjut' : 'Selesai'}</div>
                                        <div className="text-xs opacity-80 font-bold">{currentRowIndex < currentZone.count ? '(下一排)' : '(完成)'}</div>
                                    </div>
                                    <IconArrowRight />
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );

            const SummaryScreen = () => {
                const totalEggs = Object.values(batchData).reduce((acc, curr) => acc + parseInt(curr.egg || 0), 0);
                const totalDead = Object.values(batchData).reduce((acc, curr) => acc + parseInt(curr.dead || 0), 0);

                return (
                    <div className="flex flex-col h-full bg-gray-50">
                        <div className={`${currentZone.color} text-white p-4 shadow-md flex justify-between items-center`}>
                            <div>
                                <h2 className="text-2xl font-bold">Periksa</h2>
                                <div className="text-sm opacity-80 font-bold">(檢查)</div>
                            </div>
                            <div className="text-right text-xs font-bold opacity-90">{formatDateWithDay(date)}</div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar">
                            {Array.from({ length: currentZone.count }, (_, i) => i + 1).map(idx => {
                                const data = batchData[idx] || { egg: '?', dead: '?' };
                                return (
                                    <div key={idx} onClick={() => handleEditRow(idx)} className="bg-white p-3 rounded-xl shadow-sm border-l-8 border-gray-300 flex justify-between active:bg-gray-50">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center font-black text-xl text-gray-600">{idx}</div>
                                            <div className="flex flex-col">
                                                <span className="text-blue-600 font-bold text-sm">Edit</span>
                                                <span className="text-gray-400 text-xs">(修改)</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-4">
                                            <div className="flex flex-col items-end"><span className="text-xs text-gray-400 font-bold">Telur</span><span className="text-2xl font-mono font-bold text-gray-800">{data.egg}</span></div>
                                            <div className="flex flex-col items-end"><span className="text-xs text-gray-400 font-bold">Mati</span><span className={`${data.dead !== '0' ? 'text-red-600' : 'text-gray-300'} text-2xl font-mono font-bold`}>{data.dead}</span></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="bg-white p-4 border-t shadow-2xl">
                            <div className="flex justify-between mb-4 px-2 text-center">
                                <div><div className="text-sm text-gray-500 font-bold">Total Telur</div><div className="text-3xl font-black text-blue-600">{totalEggs}</div></div>
                                <div><div className="text-sm text-gray-500 font-bold">Total Mati</div><div className="text-3xl font-black text-red-600">{totalDead}</div></div>
                            </div>
                            <button onClick={() => handleFinalSubmit('ZONE_DATA')} disabled={isSaving} className="w-full bg-green-600 text-white rounded-xl py-3 shadow-lg flex flex-col items-center justify-center active:scale-95 border-b-4 border-green-800 disabled:opacity-50">
                                {isSaving ? (
                                    <span className="text-xl font-bold">Menyimpan...</span>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-2"><IconSave /><span className="text-2xl font-bold">Simpan</span></div>
                                        <span className="text-xs opacity-80 font-bold">(存檔)</span>
                                    </>
                                )}
                            </button>
                            <button onClick={handleCancel} className="w-full mt-3 bg-gray-400 text-white rounded-xl py-3 shadow-lg flex flex-col items-center justify-center active:scale-95 border-b-4 border-gray-600">
                                <div className="flex items-center gap-2"><IconX /><span className="text-xl font-bold">Batal</span></div>
                                <span className="text-xs opacity-80 font-bold">(取消)</span>
                            </button>
                        </div>
                    </div>
                );
            };

            const SuccessScreen = () => (
                <div className="flex flex-col h-full items-center justify-center bg-green-500 text-white p-8">
                    <div className="bg-white text-green-500 rounded-full p-6 mb-6 shadow-xl animate-bounce"><IconCheck /></div>
                    <h2 className="text-5xl font-black mb-2">Selesai!</h2>
                    <p className="text-2xl font-bold opacity-80 mb-8">(完成)</p>
                    <button onClick={() => setStep('ZONE')} className="bg-white text-green-700 px-8 py-4 rounded-full text-xl font-bold shadow-xl border-b-4 border-green-800 active:scale-95 flex flex-col items-center">
                        <span>Area Lain</span>
                        <span className="text-sm opacity-80">(下一區)</span>
                    </button>
                    <button onClick={() => setStep('DATE')} className="text-white underline font-bold mt-8 opacity-80 text-lg">Ganti Tanggal (換日期)</button>
                </div>
            );

            return (
                <div className="w-full max-w-md mx-auto h-screen bg-white overflow-hidden relative font-sans select-none flex flex-col">
                    {step === 'DATE' && <DateScreen />}
                    {step === 'ZONE' && <ZoneScreen />}
                    {step === 'GLOBAL_INPUT' && <GlobalInputScreen />}
                    {step === 'WIZARD' && <WizardScreen />}
                    {step === 'SUMMARY' && <SummaryScreen />}
                    {step === 'SUCCESS' && <SuccessScreen />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
